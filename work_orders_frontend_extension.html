<!-- Work Orders Tab Content -->
<!-- Add this to your enhanced_resume_app_api.html file -->

<div id="work-orders" class="tab-content">
    <div class="controls">
        <div class="control-group">
            <h3>üîß FieldNation Work Orders</h3>
            <div class="stats-overview" id="work-orders-stats">
                <!-- Stats will be populated here -->
            </div>
        </div>
        
        <div class="control-group">
            <label for="work-category-filter">Category:</label>
            <select id="work-category-filter">
                <option value="">All Categories</option>
            </select>
            
            <label for="company-filter">Company:</label>
            <input type="text" id="company-filter" placeholder="Search companies...">
            
            <label for="work-type-filter">Work Type:</label>
            <select id="work-type-filter">
                <option value="">All Types</option>
            </select>
            
            <button onclick="loadWorkOrders()" class="btn btn-primary">üîç Search</button>
            <button onclick="generateWorkOrderComponents()" class="btn btn-secondary">üìÑ Generate Resume Components</button>
        </div>
    </div>
    
    <div class="work-orders-grid" id="work-orders-grid">
        <!-- Work orders will be populated here -->
    </div>
    
    <div class="pagination" id="work-orders-pagination">
        <!-- Pagination controls -->
    </div>
</div>

<style>
.work-orders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.work-order-card {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.work-order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.work-order-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.work-order-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--dark-text);
    margin-bottom: 5px;
    line-height: 1.3;
}

.work-order-company {
    font-size: 14px;
    color: var(--primary-color);
    font-weight: 500;
}

.work-order-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-size: 13px;
    color: #666;
}

.work-order-pay {
    font-weight: 600;
    color: var(--success-color);
    font-size: 14px;
}

.work-order-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 15px;
}

.work-order-tag {
    background: var(--light-bg);
    color: var(--dark-text);
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    border: 1px solid var(--border-color);
}

.work-order-tag.category {
    background: var(--primary-color);
    color: white;
}

.work-order-tag.technology {
    background: var(--accent-color);
    color: white;
}

.work-order-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 15px;
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.btn-small {
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 4px;
}

.include-resume {
    background: var(--success-color);
    color: white;
}

.highlight-project {
    background: var(--warning-color);
    color: white;
}
</style>

<script>
// Work Orders JavaScript Functions

let currentWorkOrdersPage = 0;
const workOrdersPerPage = 20;
let workOrdersFilters = {
    category: '',
    company: '',
    work_type: '',
    client_type: '',
    state: ''
};

async function initializeWorkOrders() {
    try {
        await loadWorkOrdersStats();
        await loadWorkOrdersFilters();
        await loadWorkOrders();
    } catch (error) {
        console.error('Error initializing work orders:', error);
        showNotification('Error loading work orders', 'error');
    }
}

async function loadWorkOrdersStats() {
    try {
        const response = await fetch(`${API_BASE_URL}/work-orders/stats`);
        const stats = await response.json();
        
        const statsHtml = `
            <div class="stat-card">
                <div class="stat-value">${stats.total_orders.toLocaleString()}</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">$${stats.total_earnings.toLocaleString()}</div>
                <div class="stat-label">Total Earnings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.unique_companies}</div>
                <div class="stat-label">Companies</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">$${Math.round(stats.average_pay)}</div>
                <div class="stat-label">Avg Pay</div>
            </div>
        `;
        
        document.getElementById('work-orders-stats').innerHTML = statsHtml;
        
    } catch (error) {
        console.error('Error loading work orders stats:', error);
    }
}

async function loadWorkOrdersFilters() {
    try {
        const response = await fetch(`${API_BASE_URL}/work-orders/categories`);
        const categories = await response.json();
        
        // Populate category filter
        const categorySelect = document.getElementById('work-category-filter');
        categorySelect.innerHTML = '<option value="">All Categories</option>';
        categories.categories.forEach(cat => {
            if (cat) {
                categorySelect.innerHTML += `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`;
            }
        });
        
        // Populate work type filter
        const workTypeSelect = document.getElementById('work-type-filter');
        workTypeSelect.innerHTML = '<option value="">All Types</option>';
        categories.work_types.forEach(type => {
            if (type) {
                workTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
            }
        });
        
    } catch (error) {
        console.error('Error loading work orders filters:', error);
    }
}

async function loadWorkOrders() {
    try {
        // Get filter values
        workOrdersFilters.category = document.getElementById('work-category-filter').value;
        workOrdersFilters.company = document.getElementById('company-filter').value;
        workOrdersFilters.work_type = document.getElementById('work-type-filter').value;
        
        // Build query parameters
        const params = new URLSearchParams({
            limit: workOrdersPerPage,
            offset: currentWorkOrdersPage * workOrdersPerPage
        });
        
        Object.keys(workOrdersFilters).forEach(key => {
            if (workOrdersFilters[key]) {
                params.append(key, workOrdersFilters[key]);
            }
        });
        
        const response = await fetch(`${API_BASE_URL}/work-orders?${params}`);
        const workOrders = await response.json();
        
        displayWorkOrders(workOrders);
        
    } catch (error) {
        console.error('Error loading work orders:', error);
        showNotification('Error loading work orders', 'error');
    }
}

function displayWorkOrders(workOrders) {
    const grid = document.getElementById('work-orders-grid');
    
    if (workOrders.length === 0) {
        grid.innerHTML = '<div class="no-results">No work orders found matching your criteria.</div>';
        return;
    }
    
    const workOrdersHtml = workOrders.map(wo => {
        const serviceDate = wo.service_date ? new Date(wo.service_date).toLocaleDateString() : 'N/A';
        const pay = wo.pay_amount ? `$${wo.pay_amount.toFixed(2)}` : 'N/A';
        
        // Parse technologies and skills
        const technologies = wo.technologies_used || [];
        const skills = wo.skills_demonstrated || [];
        
        const tagsHtml = [
            `<span class="work-order-tag category">${wo.work_category || 'general'}</span>`,
            `<span class="work-order-tag">${wo.client_type || 'enterprise'}</span>`,
            ...technologies.slice(0, 3).map(tech => `<span class="work-order-tag technology">${tech}</span>`),
            ...skills.slice(0, 2).map(skill => `<span class="work-order-tag">${skill}</span>`)
        ].join('');
        
        return `
            <div class="work-order-card" data-id="${wo.id}">
                <div class="work-order-header">
                    <div>
                        <div class="work-order-title">${wo.title}</div>
                        <div class="work-order-company">${wo.company_name}</div>
                    </div>
                </div>
                
                <div class="work-order-meta">
                    <span>üìÖ ${serviceDate}</span>
                    <span class="work-order-pay">üí∞ ${pay}</span>
                </div>
                
                <div class="work-order-tags">
                    ${tagsHtml}
                </div>
                
                <div class="work-order-actions">
                    <button class="btn btn-small ${wo.include_in_resume ? 'include-resume' : ''}" 
                            onclick="toggleIncludeInResume(${wo.id}, ${!wo.include_in_resume})">
                        ${wo.include_in_resume ? '‚úì In Resume' : '+ Add to Resume'}
                    </button>
                    <button class="btn btn-small ${wo.highlight_project ? 'highlight-project' : ''}" 
                            onclick="toggleHighlightProject(${wo.id}, ${!wo.highlight_project})">
                        ${wo.highlight_project ? '‚≠ê Featured' : '‚òÜ Feature'}
                    </button>
                    <button class="btn btn-small" onclick="viewWorkOrderDetails(${wo.id})">
                        üìã Details
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    grid.innerHTML = workOrdersHtml;
}

async function toggleIncludeInResume(workOrderId, include) {
    try {
        const response = await fetch(`${API_BASE_URL}/work-orders/${workOrderId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                include_in_resume: include
            })
        });
        
        if (response.ok) {
            showNotification(include ? 'Added to resume components' : 'Removed from resume components', 'success');
            await loadWorkOrders(); // Refresh the display
        } else {
            throw new Error('Failed to update work order');
        }
        
    } catch (error) {
        console.error('Error updating work order:', error);
        showNotification('Error updating work order', 'error');
    }
}

async function toggleHighlightProject(workOrderId, highlight) {
    try {
        const response = await fetch(`${API_BASE_URL}/work-orders/${workOrderId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                highlight_project: highlight
            })
        });
        
        if (response.ok) {
            showNotification(highlight ? 'Project featured' : 'Project unfeatured', 'success');
            await loadWorkOrders(); // Refresh the display
        } else {
            throw new Error('Failed to update work order');
        }
        
    } catch (error) {
        console.error('Error updating work order:', error);
        showNotification('Error updating work order', 'error');
    }
}

async function generateWorkOrderComponents() {
    try {
        const response = await fetch(`${API_BASE_URL}/work-orders/resume-components`);
        const components = await response.json();
        
        if (components.length === 0) {
            showNotification('No work orders selected for resume inclusion', 'warning');
            return;
        }
        
        showNotification(`Generated ${components.length} resume components from work orders`, 'success');
        
        // Switch to components tab and refresh
        openTab(null, 'components');
        await loadComponents();
        
    } catch (error) {
        console.error('Error generating resume components:', error);
        showNotification('Error generating resume components', 'error');
    }
}

async function viewWorkOrderDetails(workOrderId) {
    try {
        const response = await fetch(`${API_BASE_URL}/work-orders/${workOrderId}`);
        const workOrder = await response.json();
        
        // Create modal or detailed view
        const modalHtml = `
            <div class="modal-overlay" onclick="closeModal()">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>${workOrder.title}</h3>
                        <button onclick="closeModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Company:</strong> ${workOrder.company_name}</p>
                        <p><strong>Work Type:</strong> ${workOrder.work_type || 'N/A'}</p>
                        <p><strong>Service Date:</strong> ${workOrder.service_date || 'N/A'}</p>
                        <p><strong>Location:</strong> ${workOrder.location || 'N/A'}</p>
                        <p><strong>Pay:</strong> $${workOrder.pay_amount?.toFixed(2) || 'N/A'}</p>
                        <p><strong>Category:</strong> ${workOrder.work_category}</p>
                        <p><strong>Client Type:</strong> ${workOrder.client_type}</p>
                        
                        <h4>Technologies Used:</h4>
                        <div class="tag-list">
                            ${workOrder.technologies_used?.map(tech => `<span class="tag">${tech}</span>`).join('') || 'None specified'}
                        </div>
                        
                        <h4>Skills Demonstrated:</h4>
                        <div class="tag-list">
                            ${workOrder.skills_demonstrated?.map(skill => `<span class="tag">${skill}</span>`).join('') || 'None specified'}
                        </div>
                        
                        ${workOrder.work_description ? `<h4>Description:</h4><p>${workOrder.work_description}</p>` : ''}
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Error loading work order details:', error);
        showNotification('Error loading work order details', 'error');
    }
}

function closeModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// Initialize work orders when the tab is opened
document.addEventListener('DOMContentLoaded', function() {
    // Add work orders tab button to navigation
    const tabsContainer = document.querySelector('.tabs');
    if (tabsContainer) {
        tabsContainer.insertAdjacentHTML('beforeend', `
            <button class="tablink" onclick="openTab(event, 'work-orders')">üîß Work Orders</button>
        `);
    }
});
</script> 